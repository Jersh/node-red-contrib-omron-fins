<style>
    .c-mode-form-tip {
        display: inline-block !important;
        /* width: 70%; */
        background: #ffe;
        border-radius: 2px;
        border: 1px solid #ddd;
        margin-top: 2px;
        width: calc(100% - 150px);
        overflow: auto;
        /* max-width: 450px; */
    }
    .c-mode-ui-container {
        display: inline-block;
        width: calc(100% - 150px);
    }
    .c-mode-row>label {
        width: 120px !important;
    }
</style>

<script type="text/javascript">
    (function () {

        const COMMANDS = [
            {
                headerCode: "RR",
                name: "CIO AREA READ – – RR",
                hint: "Reads the contents of the specified number of CIO words starting from the specified word",
                request: [
                    {name: "Address", type: "bcd4", min: 0, max: 6143, required: true, hint: "Beginning Word 0 to 6143"},
                    {name: "Length", type: "bcd4", min: 1, max: 6144, required: true, hint: "Number of words 1 to 6144"}
                ],
                response: [{name: "Data", type: "uint[]", min: 1, max: 6144, required: true, hint: "Data read from PLC"}],
            },
            {
                headerCode: "RL",
                name: "LR AREA READ – – RL",
                hint: "Treats CIO 1000 to CIO 1199 as a data link area and reads the contents of the specified number of words starting from the specified word",
                request: [
                    {name: "Address", type: "bcd4", min: 0, max: 199, required: true, hint: "Beginning Word 0 to 199"},
                    {name: "Length", type: "bcd4", min: 1, max: 200, required: true, hint: "Number of words 1 to 200"}
                ],
                response: [{name: "Data", type: "uint[]", min: 1, max: 200, required: true, hint: "Data read from PLC"}],
            },
            {
                headerCode: "RH",
                name: "HR AREA READ – – RH",
                hint: "Reads the contents of the specified number of HR words starting from the specified word",
                request: [
                    {name: "Address", type: "bcd4", min: 0, max: 511, required: true, hint: "Beginning Word 0 to 511"},
                    {name: "Length", type: "bcd4", min: 1, max: 512, required: true, hint: "Number of words 1 to 512"}
                ],
                response: [{name: "Data", type: "uint[]", min: 1, max: 200, required: true, hint: "Data read from PLC"}],
            },
            {
                headerCode: "RC",
                name: "TIMER/COUNTER PV READ – – RC",
                hint: "Reads the contents of the specified number of timer/counter PVs (present values T0000 to T2047 or C0000 to C2047) starting from the specified timer/counter",
                request: [
                    {name: "Address", type: "bcd4", min: 0, max: 4095, required: true, hint: "Beginning Word: Timer 0~2047 use 0~2047, Counter 0~2047 use 2047~4095"},
                    {name: "Length", type: "bcd4", min: 1, max: 2048, required: true, hint: "Number of words 1 to 2048"}
                ],
                response: [{name: "Data", type: "bcd4[]", min: 1, max: 2048, required: true, hint: "Data read from PLC"}],
            },
            {
                headerCode: "RG",
                name: "TIMER/COUNTER STATUS READ – – RG",
                hint: "Reads the ON/OFF status of the Completion Flags of the specified number of timers/counters starting from the designated word (T0000 to T2047 or C0000 to C2047).",
                request: [
                    {name: "Address", type: "bcd4", min: 0, max: 4095, required: true, hint: "Beginning Word: Timer 0~2047 use 0~2047, Counter 0~2047 use 2047~4095"},
                    {name: "Length", type: "bcd4", min: 1, max: 2048, required: true, hint: "Number of words 1 to 2048"}
                ],
                response: [{name: "Data", type: "bool[]", min: 1, max: 2048, required: true, hint: "Data read from PLC"}],
            },
            {
                headerCode: "RD",
                name: "DM AREA READ – – RD",
                hint: "Reads the contents of the specified number of DM words starting from the specified word (D00000 to D09999)",
                request: [
                    {name: "Address", type: "bcd4", min: 0, max: 9999, required: true, hint: "Beginning Word 0 to 9999"},
                    {name: "Length", type: "bcd4", min: 1, max: 9999, required: true, hint: "Number of words 1 to 9999"}
                ],
                response: [{name: "Data", type: "uint[]", min: 1, max: 6144, required: true, hint: "Data read from PLC"}],
            },
            {
                headerCode: "RE",
                name: "EM AREA READ – – RE",
                hint: "Reads the contents of the specified number of EM words (E00000 to E09999) starting from the specified word in the specified EM bank",
                request: [
                    {name: "Bank", type: "uint", min: 0, max: 0xc, required: true, hint: "Bank No 0 to 12 (bank 0 ~ bank C)"},
                    {name: "Address", type: "bcd4", min: 0, max: 9999, required: true, hint: "Beginning Word 0 to 9999"},
                    {name: "Length", type: "bcd4", min: 1, max: 9999, required: true, hint: "Number of words 1 to 9999"}
                ],
                response: [{name: "Data", type: "uint[]", min: 1, max: 6144, required: true, hint: "Data read from PLC"}],
            },
            {
                headerCode: "RJ",
                name: "AR AREA READ – – RJ",
                hint: "Reads the contents of the specified number of Auxiliary Area words (A000 to A959) starting from the specified word",
                request: [
                    {name: "Address", type: "bcd4", min: 0, max: 959, required: true, hint: "Beginning Word 0 to 959"},
                    {name: "Length", type: "bcd4", min: 1, max: 960, required: true, hint: "Number of words 1 to 960"}
                ],
                response: [{name: "Data", type: "uint[]", min: 1, max: 6144, required: true, hint: "Data read from PLC"}],
            },


            {
                headerCode: "WR",
                name: "CIO AREA WRITE – – WR",
                hint: "Writes data to the CIO Area (CIO 0000 to CIO 6143) starting from the specified word. Writing is done in word units",
                request: [
                    {name: "Address", type: "bcd4", min: 0, max: 6143, required: true, hint: "Beginning Word 0 to 6143"},
                    {name: "Data", type: "uint[]", min: 1, max: 6144, required: true, hint: "Write data (single or array)"}
                ],
                response: [],
            },



            {
                headerCode: "TS",
                name: "TEST",
                hint: "Returns, unaltered, one block of data transmitted from the host computer",
                request: [{name: "data", type: "str", min: 1, max: 118, required: true, hint: "Any characters other than the carriage return"}],
                response: [{name: "data", type: "str", min: 1, max: 118, required: true, hint: "The same characters specified in the command will be returned unaltered if the test is successful"}],
            },

            {
                headerCode: "MM",
                name: "PLC MODEL READ – – MM",
                hint: "Reads the model code of the CPU Unit",
                request: [],
                response: [
                    {
                        name: "data", type: "str", length: 2, required: true, hint: "The model code of the CPU Unit",
                        parser: e => { 
                            return {
                                code: e,
                                model: MODEL_CODES[e] || "Unknown"
                            }
                        }
                    }
                ],
            },
        ]

        function __resize(node) {
            if (!node._sizeHackTimer) {
                node._sizeHackTimer = setTimeout(function () {
                    //hack - prevent node-red calculating UI panel too large due to long text in the tip
                    $(".c-mode-form-tip").css("max-width","unset");
                    $(".c-mode-param-row").css("max-width","unset");
                    node._sizeHackTimer = null;
                }, 300);
            }
        }

        RED.nodes.registerType('C-Mode Command', {
            category: 'OMRON',
            color: '#0090d4',
            defaults: {
                name: { value: "" },
                plcSeries: { value: "CSJP" },
                hostNumber: { value: 0 },
                headerCode: { value: "TS" },
                p1: { value: "" },
                p2: { value: "" },
                p3: { value: "" },
            },
            inputs: 1,
            outputs: 1,
            outputLabels: "C-Mode Command",
            icon: "read.png",
            label: function () {
                return this.name || "C-Mode Command";
            },
            oneditprepare() {
                const node = this;
                debugger
                const $headerCodeDropdown = $("#node-input-headerCode");
                const cmd = COMMANDS.find(e=>e.headerCode==node.headerCode);
                for (let index = 0; index < COMMANDS.length; index++) {
                    const param = COMMANDS[index];
                    const o = new Option(param.name, param.headerCode, param.headerCode == node.headerCode);
                    $(o).html(param.name);// jquery(ify) the DOM object so we can use the html method
                    $headerCodeDropdown.append(o);
                }
                
                const other = new Option("- set by msg.headerCode -", "");
                $(other).html(other.text);// jquery(ify) the DOM object so we can use the html method
                $headerCodeDropdown.append(other);

                $headerCodeDropdown.on("change", function(e) {
                    debugger
                    const hc = $(this).val();
                    const cmd = COMMANDS.find(e=>e.headerCode==hc);
                    const $paramRows = [$(".form-row.c-mode-param-row.param-row-1"), $(".form-row.c-mode-param-row.param-row-2"), $(".form-row.c-mode-param-row.param-row-3")];
                    const $paramLabels = [$(".form-row.c-mode-param-row.param-row-1 > label:first-of-type"), $(".form-row.c-mode-param-row.param-row-2 > label:first-of-type"), $(".form-row.c-mode-param-row.param-row-3 > label:first-of-type")];
                    const $paramValues = [$(".form-row.c-mode-param-row.param-row-1 > input:first-of-type"), $(".form-row.c-mode-param-row.param-row-2 > input:first-of-type"), $(".form-row.c-mode-param-row.param-row-3 > input:first-of-type")];
                    
                    if(cmd) {
                        //known/preset command
                        const reqParams = cmd ? cmd.request : [];
                        for (let index = 0; index < $paramRows.length; index++) {
                            $paramRows[index].hide();
                            $paramValues[index].val("");
                        }
                        for (let index = 0; index < reqParams.length; index++) {
                            const param = reqParams[index];
                            $paramLabels[index].html('<b>P' + (index+1) + ':</b> ' + (param.name || ("Parameter " + (index + 1))) );
                            $paramValues[index].val(node["p" + (index+1)] || "");
                            $paramRows[index].show();
                            let hint = param.hint ? param.hint + '. ' : '';
                            $("#c-mode-tip-p"+(index+1)).text(hint + 'Leave this parameter blank to set it via msg.p' + (index+1) + '.');
                            $("#c-mode-tip-p"+(index+1)).show();
                        }
                        $("#c-mode-tip-header-code").text(cmd.hint);
                        $("#c-mode-tip-header-code").show();

                    } else {
                        for (let index = 0; index < $paramRows.length; index++) {
                            $paramLabels[index].html('<b>P' + (index+1) + ':</b> Data');
                            $paramRows[index].show();
                            $("#c-mode-tip-p"+(index+1)).text('optional: depends on msg.headerCode. Refer to OMRON hostlink manuals. Leave this parameter blank to set it via msg.p' + (index+1) + '.');
                            $("#c-mode-tip-p"+(index+1)).show();
                        }
                        $("#c-mode-tip-header-code").text("Pass the headerCode in via msg.headerCode");
                        $("#c-mode-tip-header-code").show();
                    }
                })

                //hack - prevent node-red calculating UI panel too large due to long text in the tip
                $(".c-mode-form-tip").css("max-width","450px");
                $(".c-mode-form-tip").hide();//will get show / hid as required when function type is set
                $(".c-mode-param-row").css("max-width","450px");
                $(".c-mode-param-row").hide();

                $headerCodeDropdown.trigger("change");

                __resize(node);
            },
            oneditresize: function(size) {
                __resize(this);
            }
        });
    })()
</script>

<script type="text/html" data-template-name="C-Mode Command">
    <div class="form-row c-mode-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" style="width: calc(100% - 150px)" placeholder="Name">
    </div>
    <div class="form-row c-mode-row">
        <label for="node-input-plcSeries"><i class="fa fa-tag"></i> PLC Type</span></label>
        <select id="node-input-plcSeries" style="width: calc(100% - 150px)">
            <option value="CSJP">CS/CJ/CP</option>
            <option value="CV">CV500/CV1000/CV2000/CVM1</option>
            <option value="Calpha">C/CPM/CPL/CQM</option>
        </select>
    </div>
    <div class="form-row c-mode-row">
        <label for="node-input-hostNumber"><i class="fa fa-tag"></i> Host Number</span></label>
        <input type="text" id="node-input-hostNumber" style="width: calc(100% - 150px)" placeholder="Host Number">
    </div>
    <div class="form-row c-mode-row">
        <label for="node-input-headerCode"><i class="fa fa-tag"></i> Header Code</label>
        <select id="node-input-headerCode" style="width: calc(100% - 150px)" >
        </select>
        <br>
        <label>&nbsp;</label>
        <div id="c-mode-tip-header-code" class="c-mode-form-tip paramtip"  style="width: calc(100% - 150px); max-width: 450px" hidden></div>
    </div>

    <div class="form-row c-mode-row c-mode-param-row param-row-1">
        <label for="node-input-p1"><i class="fa fa-tag"></i> Parameter</label>
        <input type="text" id="node-input-p1" style="width: calc(100% - 150px)" >
        <br>
        <label>&nbsp;</label>
        <div id="c-mode-tip-p1" class="c-mode-form-tip paramtip"  style="width: calc(100% - 150px); max-width: 450px" hidden></div>
    </div>
    <div class="form-row c-mode-row c-mode-param-row param-row-2">
        <label for="node-input-p2"><i class="fa fa-tag"></i> Parameter</label>
        <input type="text" id="node-input-p2" style="width: calc(100% - 150px)" >
        <br>
        <label>&nbsp;</label>
        <div id="c-mode-tip-p2" class="c-mode-form-tip paramtip"  style="width: calc(100% - 150px); max-width: 450px" hidden></div>
    </div>
    <div class="form-row c-mode-row c-mode-param-row param-row-3">
        <label for="node-input-p3"><i class="fa fa-tag"></i> Parameter</label>
        <input type="text" id="node-input-p3" style="width: calc(100% - 150px)" >
        <br>
        <label>&nbsp;</label>
        <div id="c-mode-tip-p3" class="c-mode-form-tip paramtip"  style="width: calc(100% - 150px); max-width: 450px" hidden></div>
    </div>
</script>

<script type="text/markdown" data-help-name="C-Mode Command">
OMRON C-Mode Command builder.  
### Inputs
:   payload        (string | buffer) :  data to be sent with the command
:  *hostNumber*             (string) :  The host number to send this command to (optional, defaults to 00)
:  *headerCode*             (string) :  The header code (command) to issue (optional, defaults to RR)
</script>